# 系统架构

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           用户界面层                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────┐  │
│  │   sslcon    │    │   GUI App   │    │     Third-party App     │  │
│  │    (CLI)    │    │ (WebSocket) │    │      (WebSocket)        │  │
│  └──────┬──────┘    └──────┬──────┘    └───────────┬─────────────┘  │
└─────────┼──────────────────┼───────────────────────┼────────────────┘
          │                  │                       │
          │    WebSocket JSON-RPC 2.0 (ws://127.0.0.1:6210/rpc)
          │                  │                       │
┌─────────┼──────────────────┼───────────────────────┼────────────────┐
│         ▼                  ▼                       ▼                │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     RPC 服务层 (rpc/)                        │   │
│  │  - WebSocket 连接管理                                        │   │
│  │  - JSON-RPC 请求路由                                         │   │
│  │  - 状态通知推送                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                               │                                     │
│                               ▼                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     业务逻辑层                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │   │
│  │  │    auth/    │  │   session/  │  │        vpn/         │  │   │
│  │  │  VPN 认证   │  │  会话管理   │  │   隧道管理          │  │   │
│  │  │            │  │            │  │  ┌───────┬───────┐   │  │   │
│  │  │ - InitAuth │  │ - Session  │  │  │  TLS  │ DTLS  │   │  │   │
│  │  │ - Password │  │ - ConnSess │  │  │ (TCP) │ (UDP) │   │  │   │
│  │  │   Auth     │  │ - DtlsSess │  │  └───────┴───────┘   │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                               │                                     │
│                               ▼                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     基础设施层                               │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────┐  │   │
│  │  │  tun/    │  │  proto/  │  │  utils/  │  │   base/    │  │   │
│  │  │ TUN设备  │  │ 协议定义 │  │ 工具函数 │  │ 配置/日志  │  │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                          vpnagent 后台服务                          │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         操作系统层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐ │
│  │  TUN 驱动   │  │  路由表     │  │       DNS 配置              │ │
│  └─────────────┘  └─────────────┘  └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

## 数据流

### 连接建立流程

```
1. 用户发起连接请求
   │
   ▼
2. auth.InitAuth() - TLS 握手，获取认证路径和用户组
   │
   ▼
3. auth.PasswordAuth() - 发送凭证，获取 SessionToken
   │
   ▼
4. vpn.SetupTunnel() - 发送 HTTP CONNECT，建立隧道
   │
   ├──► 创建 TUN 虚拟网卡
   ├──► 配置 IP 地址
   ├──► 设置路由规则
   │
   ▼
5. 启动数据通道
   ├──► tlsChannel (TCP) - 主通道
   └──► dtlsChannel (UDP) - 可选，低延迟通道
```

### 数据传输流程

```
应用数据 ──► TUN设备 ──► tunToPayloadOut ──► PayloadOutTLS/DTLS ──► 服务器
                                                    │
应用数据 ◄── TUN设备 ◄── payloadInToTun ◄── PayloadIn ◄──────────────┘
```

## 模块依赖关系

```
                    ┌─────────┐
                    │  main   │
                    └────┬────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
    ┌────────┐      ┌────────┐      ┌────────┐
    │  cmd   │      │  rpc   │      │  svc   │
    └────┬───┘      └────┬───┘      └────┬───┘
         │               │               │
         └───────────────┼───────────────┘
                         │
                         ▼
                    ┌────────┐
                    │  auth  │ ◄─────┐
                    └────┬───┘       │
                         │           │
                         ▼           │
                    ┌────────┐       │
                    │  vpn   │───────┤
                    └────┬───┘       │
                         │           │
         ┌───────────────┼───────────┘
         │               │
         ▼               ▼
    ┌────────┐      ┌──────────┐
    │  tun   │      │ session  │
    └────────┘      └──────────┘
         │               │
         └───────┬───────┘
                 │
    ┌────────────┼────────────┐
    │            │            │
    ▼            ▼            ▼
┌────────┐  ┌────────┐  ┌────────┐
│ proto  │  │ utils  │  │  base  │
└────────┘  └────────┘  └────────┘
```

## 并发模型

项目使用 Go 协程实现高效的并发处理：

| 协程 | 职责 |
|------|------|
| `tlsChannel` | TLS 通道读取服务器数据 |
| `payloadOutTLSToServer` | TLS 通道发送数据到服务器 |
| `dtlsChannel` | DTLS 通道读取服务器数据 |
| `payloadOutDTLSToServer` | DTLS 通道发送数据到服务器 |
| `tunToPayloadOut` | 从 TUN 设备读取数据 |
| `payloadInToTun` | 向 TUN 设备写入数据 |
| `DPDTimer` | Dead Peer Detection 心跳 |
| `ReadDeadTimer` | 读超时重置定时器 |
| `monitor` | 监控连接状态并通知客户端 |

## 通道设计

使用 Go Channel 实现协程间通信：

```go
PayloadIn      chan *proto.Payload  // 服务器 → TUN (容量64)
PayloadOutTLS  chan *proto.Payload  // TUN → TLS服务器 (容量64)
PayloadOutDTLS chan *proto.Payload  // TUN → DTLS服务器 (容量64)
CloseChan      chan struct{}        // 关闭信号
DtlsSetupChan  chan struct{}        // DTLS建立完成信号
```
